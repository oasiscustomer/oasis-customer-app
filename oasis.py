# -*- coding: utf-8 -*-
"""oasis.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IB86aqF8JjCHaMrFHhoaDmbFxtJ5DkyJ
"""

# -*- coding: utf-8 -*-
"""oasis.py

Streamlit Cloud ë° Google Colabì—ì„œ ì‹¤í–‰ë˜ëŠ” ì°¨ëŸ‰ ë²ˆí˜¸íŒ ì¸ì‹ ì‹œìŠ¤í…œ
"""

import os
import pytesseract
import shutil
import subprocess
import cv2
import re
import sys
import gspread
import streamlit as st
from google.auth.transport.requests import Request
from google.oauth2 import service_account
from PIL import Image
import tempfile

st.title("ğŸš— ì„¸ì°¨ì¥ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ")
st.write("ğŸ“¸ ì°¨ëŸ‰ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ê³ ê° ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

# ğŸ“¤ JSON í‚¤ íŒŒì¼ ì—…ë¡œë“œ (Google Colab & Streamlit Cloud ëŒ€ì‘)
st.subheader("1ï¸âƒ£ Google Sheets API í‚¤ íŒŒì¼ ì—…ë¡œë“œ")
json_key_path = None  # ì´ˆê¸°í™”

uploaded_key = st.file_uploader("ğŸ”‘ Google Cloudì—ì„œ ë‹¤ìš´ë¡œë“œí•œ JSON í‚¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.", type=["json"])
if uploaded_key is not None:
    temp_key_file = tempfile.NamedTemporaryFile(delete=False, suffix=".json")
    temp_key_file.write(uploaded_key.getbuffer())
    temp_key_file.close()  # íŒŒì¼ì„ ë‹«ì•„ì•¼ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë¨
    json_key_path = temp_key_file.name

# ğŸš¨ JSON í‚¤ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥
if not json_key_path:
    st.error("ğŸš¨ Google Sheets API JSON í‚¤ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤!")
    st.stop()

st.write(f"ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ JSON í‚¤ íŒŒì¼ ê²½ë¡œ: {json_key_path}")

# Google Sheets API ì¸ì¦ ì„¤ì •
try:
    credentials = service_account.Credentials.from_service_account_file(
        json_key_path, scopes=["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    )
    client = gspread.authorize(credentials)
    spreadsheet = client.open("Oasis Customer Management")
    worksheet = spreadsheet.worksheet("ì‹œíŠ¸1")
    st.success("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    st.error(f"ğŸš¨ Google Sheets ì¸ì¦ ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()

# ğŸ“¤ ì°¨ëŸ‰ ì‚¬ì§„ ì—…ë¡œë“œ
st.subheader("2ï¸âƒ£ ì°¨ëŸ‰ ì‚¬ì§„ ì—…ë¡œë“œ")
uploaded_image = st.file_uploader("ğŸ“¸ ì°¨ëŸ‰ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.", type=["jpg", "jpeg", "png"])
if uploaded_image is not None:
    image = Image.open(uploaded_image)
    st.image(image, caption="ì—…ë¡œë“œëœ ì´ë¯¸ì§€", use_column_width=True)

    with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as temp_image:
        temp_image.write(uploaded_image.getbuffer())
        temp_image_path = temp_image.name

    st.write(f"ğŸš— ìµœì¢… ì°¨ëŸ‰ ë²ˆí˜¸: {temp_image_path}")