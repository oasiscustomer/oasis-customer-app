# -*- coding: utf-8 -*-
"""oasis.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zUOTH4v8fMMkpnmogHbSc6nku2ox3wFT
"""

# -*- coding: utf-8 -*-
"""
oasis.py
Streamlit WebAppìš© ì™„ì„±ë³¸ (ì¤‘ë³µ í™•ì¸ ë° Google Sheets API ì˜¤ë¥˜ ëŒ€ì‘ í¬í•¨)
"""

import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
from datetime import datetime
import re
import json

# âœ… ì¸ì¦
try:
    credentials = Credentials.from_service_account_info(
        st.secrets["gcp_service_account"],
        scopes=["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    )
    client = gspread.authorize(credentials)
    worksheet = client.open("Oasis Customer Management").worksheet("ì‹œíŠ¸1")
except Exception as e:
    st.error(f"ğŸš¨ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")
    st.stop()

st.title("ğŸš— ì„¸ì°¨ì¥ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œ")
st.markdown("""
- Google Sheets ì—°ë™
- ê³ ê° ì°¨ëŸ‰ ë²ˆí˜¸ ì…ë ¥ ì‹œ ì¤‘ë³µ í™•ì¸
- í•˜ë£¨ ì¤‘ë³µ ë°©ë¬¸ ì‹œ ì‚¬ìš©ì ì¬í™•ì¸
""")

# âœ… ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "search_result" not in st.session_state:
    st.session_state.search_result = []
if "selected_customer" not in st.session_state:
    st.session_state.selected_customer = None
if "awaiting_confirmation" not in st.session_state:
    st.session_state.awaiting_confirmation = False

# âœ… ì°¨ëŸ‰ ë²ˆí˜¸ ì…ë ¥
st.subheader("2ï¸âƒ£ ê³ ê° ì°¨ëŸ‰ ì •ë³´ ì…ë ¥")
plate_input = st.text_input("ğŸ” ì°¨ëŸ‰ ë²ˆí˜¸ (ì „ì²´ ë˜ëŠ” ë 4ìë¦¬)")
search_btn = st.button("ğŸ” í™•ì¸")

# âœ… ì°¨ëŸ‰ ê²€ìƒ‰ ì²˜ë¦¬
if search_btn and plate_input:
    try:
        records = worksheet.get_all_records()
    except Exception as e:
        st.error(f"ğŸš¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        st.stop()

    # ì¡°ê±´ì— ë§ëŠ” ê³ ê° í•„í„°ë§ (dictì¸ì§€ í™•ì¸)
    matched = [r for r in records if isinstance(r, dict) and "ì°¨ëŸ‰ë²ˆí˜¸" in r and (
        plate_input in r["ì°¨ëŸ‰ë²ˆí˜¸"] or r["ì°¨ëŸ‰ë²ˆí˜¸"].endswith(plate_input)
    )]

    if len(matched) == 0:
        st.info("ğŸ†• ë“±ë¡ë˜ì§€ ì•Šì€ ì°¨ëŸ‰ì…ë‹ˆë‹¤. ì•„ë˜ì— ê³ ê° ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        new_plate = st.text_input("ğŸš˜ ì „ì²´ ì°¨ëŸ‰ë²ˆí˜¸ (ì˜ˆ: 160í˜¸ 7421)", key="new_plate")
        raw_phone = st.text_input("ğŸ“ ê³ ê° ì „í™”ë²ˆí˜¸ (ì˜ˆ: 01042921289 ë˜ëŠ” 010-4292-1289)", key="new_phone")

        def format_phone(phone):
            digits = re.sub(r"[^0-9]", "", phone)
            if len(digits) == 11:
                return f"{digits[:3]}-{digits[3:7]}-{digits[7:]}"
            return phone

        # âœ… ì¤‘ë³µ í™•ì¸
        if new_plate:
            exists = any(r["ì°¨ëŸ‰ë²ˆí˜¸"] == new_plate for r in records if isinstance(r, dict) and "ì°¨ëŸ‰ë²ˆí˜¸" in r)
            if exists:
                st.warning("ğŸš¨ ë™ì¼í•œ ì°¨ëŸ‰ë²ˆí˜¸ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.")
            elif st.button("ğŸ“¥ ì‹ ê·œ ê³ ê° ë“±ë¡") and new_plate and raw_phone:
                phone = format_phone(raw_phone)
                now = datetime.now().strftime("%Y-%m-%d %H:%M")
                date_only = now.split()[0]
                new_row = [new_plate, phone, date_only, date_only, 1, f"{now} (1)"]
                try:
                    worksheet.append_row(new_row)
                    st.success("âœ… ì‹ ê·œ ê³ ê° ë“±ë¡ ì™„ë£Œ")
                except Exception as e:
                    st.error(f"ğŸš¨ ë“±ë¡ ì‹¤íŒ¨: {e}")
    elif len(matched) == 1:
        customer = matched[0]
        st.session_state.selected_customer = customer
        st.session_state.awaiting_confirmation = False

        now_date = datetime.now().strftime("%Y-%m-%d")
        last_visit_date = customer.get("ë§ˆì§€ë§‰ ë°©ë¬¸ë‚ ì§œ", "")

        if now_date == last_visit_date:
            st.info("ğŸ“Œ ì˜¤ëŠ˜ ì´ë¯¸ ì…ë ¥ëœ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ ì…ë ¥í• ê¹Œìš”?")
            confirm = st.radio("ì…ë ¥ í™•ì¸", ["Y", "N"], key="confirm_repeat")
            if st.button("âœ… í™•ì¸"):
                if confirm == "Y":
                    st.session_state.awaiting_confirmation = False
                else:
                    st.warning("âŒ ì…ë ¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.stop()
        else:
            st.session_state.awaiting_confirmation = True

    elif len(matched) > 1:
        options = [r["ì°¨ëŸ‰ë²ˆí˜¸"] for r in matched]
        selected = st.selectbox("ğŸš˜ ì—¬ëŸ¬ ì°¨ëŸ‰ì´ ì¼ì¹˜í•©ë‹ˆë‹¤. ì „ì²´ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.", options)
        if selected:
            customer = next(r for r in matched if r["ì°¨ëŸ‰ë²ˆí˜¸"] == selected)
            st.session_state.selected_customer = customer
            st.session_state.awaiting_confirmation = True

# âœ… ë°©ë¬¸ ê¸°ë¡ ì²˜ë¦¬
if st.session_state.selected_customer and st.session_state.awaiting_confirmation:
    customer = st.session_state.selected_customer
    all_records = worksheet.get_all_records()
    row_index = next((i + 2 for i, r in enumerate(all_records) if r["ì°¨ëŸ‰ë²ˆí˜¸"] == customer["ì°¨ëŸ‰ë²ˆí˜¸"]), None)

    if row_index:
        now = datetime.now().strftime("%Y-%m-%d %H:%M")
        date_only = now.split()[0]
        old_log = customer.get("ë°©ë¬¸ê¸°ë¡", "")
        new_log = old_log + f", {now} (1)" if old_log else f"{now} (1)"

        try:
            worksheet.update(f"D{row_index}", [[date_only]])
            worksheet.update(f"E{row_index}", [[int(customer.get("ì´ ë°©ë¬¸ íšŸìˆ˜", 0)) + 1]])
            worksheet.update(f"F{row_index}", [[new_log]])
            st.success("ğŸ—“ ë°©ë¬¸ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
            st.session_state.awaiting_confirmation = False
            st.session_state.selected_customer = None
        except Exception as e:
            st.error(f"ğŸš¨ Google Sheets ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")