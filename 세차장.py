# -*- coding: utf-8 -*-
"""ì„¸ì°¨ì¥.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Mln4EjfYmulL3S67NIW2nIM5JI8jyKQ-
"""

!pip install gspread oauth2client pytesseract opencv-python streamlit

from google.colab import auth, files
import gspread
from google.oauth2 import service_account
import cv2
import pytesseract
import re
import streamlit as st
import tempfile
from PIL import Image

# ğŸ”‘ Google Sheets API ì„¤ì •
auth.authenticate_user()
uploaded_key = files.upload()

json_key = list(uploaded_key.keys())[0]

credentials = service_account.Credentials.from_service_account_file(
    json_key, scopes=["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
)
client = gspread.authorize(credentials)
spreadsheet = client.open("Oasis Customer Management")
worksheet = spreadsheet.worksheet("ì‹œíŠ¸1")

# ğŸš— Streamlit ì›¹ ì•± ì‹¤í–‰
st.title("ğŸš— ì°¨ëŸ‰ ë²ˆí˜¸íŒ ì¸ì‹ ì‹œìŠ¤í…œ")
uploaded_image = st.file_uploader("ğŸ“¸ ì°¨ëŸ‰ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.", type=["jpg", "jpeg", "png"])

if uploaded_image is not None:
    image = Image.open(uploaded_image)
    st.image(image, caption="ì—…ë¡œë“œëœ ì´ë¯¸ì§€", use_column_width=True)

    with tempfile.NamedTemporaryFile(delete=False, suffix=".jpg") as temp_image:
        temp_image.write(uploaded_image.getbuffer())
        temp_image_path = temp_image.name

    def recognize_license_plate(image_path):
        image = cv2.imread(image_path)
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
        plate_text = pytesseract.image_to_string(gray, lang='eng')
        plate_number_match = re.findall(r'\d{2,3}[ê°€-í£]\s?\d{4}', plate_text)
        return plate_number_match[0] if plate_number_match else None

    plate_number = recognize_license_plate(temp_image_path)

    if plate_number is None:
        plate_number = st.text_input("ğŸš¨ ë²ˆí˜¸íŒ ì¸ì‹ ì‹¤íŒ¨! ì°¨ëŸ‰ ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”:")

    st.write(f"ğŸš— ìµœì¢… ì°¨ëŸ‰ ë²ˆí˜¸: {plate_number}")

    records = worksheet.get_all_records()
    customer_exists = any(record["Vehicle number"] == plate_number for record in records)

    if customer_exists:
        st.success("âœ… ê¸°ì¡´ ê³ ê°ì…ë‹ˆë‹¤. ë°©ë¬¸ ê¸°ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.")
    else:
        phone_number = st.text_input("ğŸ“ ì‹ ê·œ ê³ ê°ì…ë‹ˆë‹¤. ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")
        if st.button("ğŸš— ì‹ ê·œ ê³ ê° ë“±ë¡"):
            new_customer = [plate_number, phone_number, "2025-03-19", "2025-03-19", 1, "2025-03-19 10:25 (1)"]
            worksheet.append_row(new_customer)
            st.success(f"âœ… ì‹ ê·œ ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: {plate_number}")